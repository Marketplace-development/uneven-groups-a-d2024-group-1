{% extends 'base.html' %}

{% block head %}
<title>Your Location Bookings</title>
{% endblock %}

{% block body %}
<div class="locations-container">
    <!-- Buttons in the right upper corner -->
    <div class="button-container" style="position: fixed; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 0px; z-index: 999;">
        <form action="{{ url_for('main.main_page') }}" method="get" class="inline-form">
            <button type="submit" class="btn btn-transparant" style="width: 200px; font-size: 1em; padding: 10px 20px;">Main Page</button>
        </form>
        <form action="{{ url_for('main.home') }}" method="get" class="inline-form">
            <button type="submit" class="btn btn-black" style="width: 200px; font-size: 1em; padding: 10px 20px;">Log out</button>
        </form>
    </div>

    <!-- Logo -->
    <div style="display: flex; justify-content: center; align-items: center; height: 100%; margin-top: 20px;">
        <img src="{{ url_for('static', filename='images/logo_wit.jpg') }}" alt="logo" style="width: 150px;">
    </div>

    <!-- Page title and subtitle -->
    <h1 style="text-align: center; color: black; font-size: 2.5em; font-weight: bold;">Your Location Bookings</h1>
    <p style="text-align: center; color: grey; font-size: 1.5em;">See who booked your location and at what time</p>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Bookings Details -->
    <div class="bookings-details">
    <h3>Your location is booked by the following people:</h3>

    {% if reservations %}
        <div class="reservations-list">
            {% for reservation in reservations %}
                <div class="reservation-card">
                    <p><strong>Username:</strong> {{ reservation.user.username }}</p>
                    <p><strong>Phonenumber:</strong> {{ reservation.user.phonenumber }}</p>
                    <p><strong>Reservation Date:</strong> {{ reservation.reservation_time.strftime('%Y-%m-%d') }}</p>
                    <p><strong>Reservation Time:</strong> {{ reservation.reservation_time.strftime('%H:%M') }}</p>
                    <p><strong>Study Time:</strong> {{ reservation.study_time }} minutes</p>
                    <p><strong>Number of Guests:</strong> {{ reservation.number_of_guests }}</p>
                    <p><strong>Student's Rating:</strong>
                        <!-- Display stars for user's rating -->
                        {% if reservation.user.user_rating %}
                            {% for star in range(1, 6) %}
                                {% if star <= reservation.user.user_rating %}
                                    <span style="color: gold;">&#9733;</span>  <!-- Filled star -->
                                {% else %}
                                    <span style="color: lightgray;">&#9733;</span>  <!-- Empty star -->
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            No rating yet.
                        {% endif %}
                    </p>
                </div>
            {% endfor %}
            
        </div>
    {% else %}
        <p>No bookings yet for your location.</p>
    {% endif %}
    </div>

    <!-- Past Bookings Details -->
    <div class="bookings-details">
    <h3>Your location was previously booked by the following people:</h3>

    {% if expired_reservations %}
        <div class="reservations-list">
            {% for reservation in expired_reservations %}
                <div class="reservation-card">
                    <p><strong>Username:</strong> {{ reservation.user.username }}</p>
                    <p><strong>Phonenumber:</strong> {{ reservation.user.phonenumber }}</p>
                    <p><strong>Reservation Date:</strong> {{ reservation.reservation_time.strftime('%Y-%m-%d') }}</p>
                    <p><strong>Reservation Time:</strong> {{ reservation.reservation_time.strftime('%H:%M') }}</p>
                    <p><strong>Study Time:</strong> {{ reservation.study_time }} minutes</p>
                    <p><strong>Number of Guests:</strong> {{ reservation.number_of_guests }}</p>

                    <!-- Display the Location Rating from Student (if available) -->
                    {% if reservation.location_rating %}
                        <p><strong>Received Rating:</strong>
                            <!-- Display stars for received location rating -->
                            {% for star in range(1, 6) %}
                                {% if star <= reservation.location_rating %}
                                    <span style="color: gold;">&#9733;</span>  <!-- Filled star -->
                                {% else %}
                                    <span style="color: lightgray;">&#9733;</span>  <!-- Empty star -->
                                {% endif %}
                            {% endfor %}
                        </p>
                    {% else %}
                        <p><strong>Received Rating:</strong> No rating yet.</p>
                    {% endif %}

                    <!-- Star Rating Form -->
                    <form method="POST" class="rating-form">
                        <input type="hidden" name="reservation_id" value="{{ reservation.id }}">
                        <strong>Rate the Student:</strong>
                        {% for star in range(1, 6) %}
                            <!-- Radio Button (Hidden) -->
                            <input
                                type="radio"
                                id="star{{ star }}-{{ reservation.id }}"
                                name="student_rating"
                                value="{{ star }}"
                                {% if reservation.student_rating == star %}checked{% endif %}
                            >
                            <!-- Star Label -->
                            <label for="star{{ star }}-{{ reservation.id }}">&#9733;</label>
                        {% endfor %}
                        <button type="submit" class="btn btn-transparant">Submit</button>
                    </form>
                </div>
            {% endfor %}  
        </div>
    {% else %}
        <p>Your location was never booked yet.</p>
    {% endif %}
    </div>
</div>

<script>
    // JavaScript for Star Rating System
    const forms = document.querySelectorAll('.rating-form'); // All forms with class "rating-form"

    forms.forEach(form => {
        const stars = Array.from(form.querySelectorAll('label')); // Star labels within the form
        const inputs = Array.from(form.querySelectorAll('input[type="radio"]')); // Radio buttons within the form

        // Highlight stars based on the checked input (saved rating)
        function highlightStars(index) {
            stars.forEach((star, i) => {
                star.style.color = i <= index ? '#FFD700' : 'lightgray'; // Highlight up to and including the index
            });
        }

        // Get checked radio button on page load
        const checkedInput = inputs.find(input => input.checked);
        if (checkedInput) {
            const checkedIndex = inputs.indexOf(checkedInput);
            highlightStars(checkedIndex);
        }

        // Add hover effects to stars
        stars.forEach((star, index) => {
            star.addEventListener('mouseover', () => highlightStars(index)); // Highlight stars on hover

            star.addEventListener('mouseout', () => {
                // Reset to the checked state or default
                const checkedInput = inputs.find(input => input.checked);
                const checkedIndex = checkedInput ? inputs.indexOf(checkedInput) : -1;
                highlightStars(checkedIndex);
            });

            star.addEventListener('click', () => {
                // Set the clicked star as the new rating
                inputs[index].checked = true; // Check corresponding radio
                highlightStars(index); // Update star colors
            });
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Find the flash message by targeting common classes for alert messages
        const flashMessages = document.querySelectorAll('.alert, .flash, .alert-success');
        flashMessages.forEach(function(flashMessage) {
            // Set a timeout to hide the message after 2 seconds
            setTimeout(function() {
                flashMessage.style.transition = 'opacity 1s ease-out';
                flashMessage.style.opacity = '0'; // Gradually fade out
                
                // After fading out, set display to 'none' to remove it from the layout
                setTimeout(function() {
                    flashMessage.style.display = 'none';
                }, 1000); // Matches the CSS transition time (1 second)
            }, 2000); // Wait 2 seconds before starting the fade-out
        });
    });
</script>

{% endblock %}
